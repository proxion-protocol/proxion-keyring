# Kleitikon Design

A Solid-compatible application for authorizing and managing trusted device
connections using the user’s Solid Pod for policy, receipts, and optionally
audit.

Positioning: Kleitikon is an app, not a VPN product. It uses Proxion (UI spec)
as the control-plane protocol and treats secure-channel establishment (e.g.,
WireGuard) as a pluggable data-plane instantiation.

## 1. Goals

### 1.1 Primary goals

- Provide a Solid-compatible, user-centric experience for pairing devices and
  granting/revoking connection authorizations.
- Store app-generated data (policies, consent receipts, optional audit) in the
  user’s Solid Pod.
- Allow users to log in with a WebID and an Identity Provider of their choice
  (Solid-OIDC/WebID-OIDC).
- Use Proxion UI semantics for:
  - single-use, short-lived permission tickets
  - issuance of capability tokens (explicit permissions + contextual caveats)
  - attenuation and revocation
  - fail-closed validation

### 1.2 Non-goals

- No claim to be a general VPN provider.
- No requirement that every participant operate a self-hosted Pod or IdP.
- No requirement that Solid be online during data transfer.
- No forced data plane: WireGuard is one instantiation; other DPs may exist.

## 2. Solid listing compliance checklist (ODI/Solid app list)

Kleitikon must satisfy the Solid Project’s app listing criteria:

- If identifying users is necessary, users must be able to log in using their
  WebID and the Identity Provider of their choice.
- Data consumed by the app should be fetched from Solid Pods if possible.
- Data generated by the app should be stored in Solid Pods.
- Interactions between app, pods, and IdP(s) must be compliant with Solid
  specifications.

Also avoid excluded categories (harm, unethical uses, hate, malware/data theft,
illegal purposes, sharing user info without consent, known serious security
issues).

Design implication: Kleitikon must be Pod-first for state, and must not
exfiltrate user data to third parties without explicit consent.

## 3. High-level architecture

### 3.1 Components

- Kleitikon App (Web UI)
  - Runs in browser.
  - Solid login (WebID-OIDC) for RO user.
  - Displays device roster, pending pairing requests, policies, and receipts.

- Kleitikon Control Plane Service (CP / AS+RS for control resources)
  - Implements Proxion lifecycle (ticket issuance, redemption, token issuance).
  - Writes policies/receipts/audit to Solid Pod (user-controlled storage).
  - Can run locally (developer) or self-hosted (user).

- Secure-Channel Resource Service (DP / RS)
  - Performs RS-side validation of tokens (audience, PoP, caveats, revocation).
  - Produces opaque connection material for the data plane.
  - For the initial EI, DP may be WireGuard (peer config / peer add+remove).

- Device Agent (Client / RP)
  - Runs on devices being paired.
  - Redeems permission tickets and requests channel bootstrap material.
  - Applies DP configuration (e.g., installs WireGuard config).

### 3.2 Trust boundaries

- User’s Pod is the canonical store for Kleitikon app state.
- Control plane validates and writes only minimized state required by policies
  and receipts.
- Data plane is independent; CP authorizes “bootstrap of secure channel,” not
  arbitrary data access.

## 4. Data model in Solid Pod

Store all Kleitikon state under a dedicated container in the RO’s Pod.

### 4.1 Suggested container layout

- `/kleitikon/`
  - `/kleitikon/policies/` — policy resources (ACP/WAC governed)
  - `/kleitikon/receipts/` — consent receipts (append-only)
  - `/kleitikon/audit/` — optional audit events (append-only, minimized)
  - `/kleitikon/devices/` — device descriptors (pairwise IDs; no stable global IDs required)
  - `/kleitikon/config/` — app config (UI preferences, defaults)

### 4.2 Resource shapes (JSON-LD recommended)

#### Device descriptor (minimal)

```json
{
  "@context": ["https://www.w3.org/ns/solid/terms"],
  "type": "KleitikonDevice",
  "device_id": "did:peer:...",
  "label": "My Laptop",
  "created_at": 0,
  "keys": {
    "holder_pub": "..."
  }
}
```

#### Policy resource (minimal)

```json
{
  "type": "KleitikonPolicy",
  "policy_id": "pol-...",
  "applies_to": {"device_id": "did:peer:..."},
  "permits": [
    {"action": "channel.bootstrap", "resource": "rs:wg0"}
  ],
  "caveats": [
    {"type": "ip_allowlist", "allowed": ["10.0.0.0/24"]},
    {"type": "time_window", "not_before": 0, "not_after": 0}
  ],
  "revocation": {"mode": "list"}
}
```

#### Consent receipt (append-only)

```json
{
  "type": "KleitikonReceipt",
  "receipt_id": "rcpt-...",
  "who": {"webid": "https://...#me"},
  "what": {"action": "channel.bootstrap", "resource": "rs:wg0"},
  "to": {"device_id": "did:peer:..."},
  "issued_at": 0,
  "expires_at": 0,
  "token_id": "sha256:..."
}
```

Privacy guidance: avoid storing network endpoints, public IPs, or long-lived
correlators unless explicitly needed.

## 5. Control-plane protocol mapping (Proxion UI)

Kleitikon must not change the frozen Proxion UI spec. It instantiates it.

### 5.1 Ticket issuance (RO -> CP)

- RO authenticates with WebID-OIDC.
- CP issues a short-lived, single-use PT.
- App produces a QR payload containing:
  - `as_uri` (control plane URL)
  - `pt` (ticket id)
  - optional `aud_hint`

### 5.2 Ticket redemption (Device RP -> CP)

- Device RP redeems PT with proof-of-possession.
- CP evaluates policy (from Pod) and issues capability token.
- CP writes a consent receipt to Pod.

### 5.3 Channel bootstrap (Device RP -> DP/RS)

- Device presents token to RS.
- RS validates and returns DP connection material.

### 5.4 Revocation

- RO revokes via Kleitikon UI -> CP writes revocation entry.
- RS enforces revocation; DP teardown performed.

## 6. WireGuard data-plane instantiation (EI)

### 6.1 What is authorized

Authorize specific RS actions, not “VPN access”:

- `action: "wg.peer.add"`, `resource: "wg:interface:wg0"`
- `action: "wg.peer.remove"`, `resource: "wg:interface:wg0"`
- optionally `action: "wg.peer.read"` for status (minimized)

### 6.2 RS responsibilities (gateway server)

- Maintain `wg0`.
- On authorized bootstrap:
  - allocate an IP from a configured pool
  - add peer (and optional preshared key)
  - return a minimal WireGuard config to RP
- On revoke:
  - remove peer
  - optionally rotate server keys (optional hardening)

### 6.3 Caveats that matter

- `ip_allowlist` / allowed IP ranges
- `time_window` / short TTL
- `nonce_matches` / freshness
- `aud` binding to RS identity

## 7. Threat model (minimal)

### 7.1 Adversaries

- QR eavesdropper (sees PT)
- MitM between RP and CP/RS
- Compromised RP device
- Honest-but-curious CP host

### 7.2 Mitigations (must implement)

- PT single-use + TTL
- token audience binding + PoP
- fail-closed RS validation
- minimize Pod data; no third-party sharing without consent
- revocation list + DP teardown

## 8. Implementation plan (phased)

### Phase 0 — Repo scaffolding (1–2 days)

- Create repo `kleitikon` with:
  - `docs/` (this design, threat model, listing checklist)
  - `app/` (web UI)
  - `cp/` (control plane service)
  - `rs/` (wireguard RS)
  - `agent/` (device agent)

### Phase 1 — Solid-compatible login + Pod storage (MVP for listing)

- Web app supports login with WebID + IdP of choice.
- App creates `/kleitikon/` container structure.
- Policies stored in Pod; receipts written in Pod.

### Phase 2 — Proxion EI integration

- CP uses `proxion-core` as library for tickets/tokens.
- RS uses `proxion-core` validator.
- Implement QR issuance and redemption.

### Phase 3 — WireGuard instantiation

- RS adds/removes peers on `wg0`.
- Device agent applies config.
- End-to-end pair+connect+revoke demo.

## 9. “Get listed” packaging

### 9.1 What the Solid app listing reviewer will look for

- A working login journey: “enter WebID -> redirected to chosen IdP -> returns to app.”
- Clear statement that Kleitikon stores its generated data in the user’s Pod.
- Clear statement of privacy boundaries and no third-party sharing without consent.

### 9.2 Submission-ready README checklist

Include:

- What the app does (device pairing / connection authorization)
- How to run it (local dev)
- Solid login instructions
- Where data is stored in Pod (`/kleitikon/...`)
- Security notes (PT TTL, PoP, revocation)
- Link to issue tracker

### 9.3 ODI contact

When ready, contact the ODI per the Solid apps page instructions.
